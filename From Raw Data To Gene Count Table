# From Raw Data to Gene-count table on HPC

# Making directory for this project and soft link of raw data files
assignment1='/export/home/biostuds/2802815l/assignment1' 
mkdir -p $assignment1 # -p to check if directory exists
data='/export/home/biostuds/2802815l/assignment1/data_new'
mkdir -p $data
cd $data

fqpath='/export/projects/polyomics/buzz/biostuds'
for sample in s1 s2 s3 s4 s5 s6 s7 s8 s9 s10 s11 s12
do
raw_file="$fqpath/${sample}.c2.fq" # path to the raw fastq file
link_name="${sample}.c2.fq" # link-name to appear in your directory
ln -s $raw_file $link_name # instruction to make a soft link
done

# RESOURCE FILES
adapter='/export/projects/polyomics/biostuds/data/illumina_adapter.fa' # path to illumina adapter file
hs2index='/export/projects/polyomics/Genome/Mus_musculus/mm10/Hisat2Index/chr2' # path to reference genome hisat2 indexes
gtf='/export/projects/polyomics/Genome/Mus_musculus/mm10/annotations/chr2.gtf' # path to GTF file
data='/export/home/biostuds/2802815l/assignment1/data_new/' # path to local data directory that you have created

# MAKE FEW SUBDIRS UNLESS THEY EXIST
hisat_dir='/export/home/biostuds/2802815l/assignment1/data_new/hisat_dir' # path to directory for hisat2 results
stringtie_dir='/export/home/biostuds/2802815l/assignment1/data_new/stringtie_dir' # path to directory for stringtie results
mkdir -p $hisat_dir # make above hisat2 directory, -p checks if such dir already exists
mkdir -p $stringtie_dir # make above stringtie directory
gtflist='list.gtf.txt' # filename for final GTF list
rm -f ${gtflist} # remove if exists

#RUNNING a single LOOP for all the work
for sample in s1 s2 s3 s4 s5 s6 s7 s8 s9 s10 s11 s12
do
fastq="$data${sample}.c2.fq" # path to raw fastq file
trim1="${sample}.t1.fq" # path to adapter-trimmed fastq file
trim2="${sample}.t2.fq" # path to quality-trimmed fastq file
scythe -o $trim1 -a $adapter -q sanger $fastq # command to execute scythe
sickle se -f $trim1 -o $trim2 -t sanger -q [10] -l [50] # command to execute sickle
hisat2 -x $hs2index -U $trim2 -S ${sample}.sam --phred33 --rna-strandness R # command to execute hisat2
samtools view -bS -o "${sample}.bam" "${sample}.sam" # command to execute samtools view
samtools sort "${sample}.bam" "${sample}.sort" # command to execute samtools sort
rm "${sample}.sam"  "${sample}.bam" # removing unnecessary files
rm $trim1 $trim2 # removing unnecessary files
str_smp_dir="$stringtie_dir/${sample}" # path to sample-specific subdirectory for stringtie results
mkdir -p $str_smp_dir # make the above directory
stringtie "${sample}.sort.bam" -p 4 -G $gtf -e -B -o "$str_smp_dir/${sample}.gtf"   # command to execute stringtie
gtfline="${sample} $str_smp_dir/${sample}.gtf" # line containing sample and path to GTF
echo $gtfline >> $gtflist # adding the above line to a file
done
#
# Converting sample-specific GTFs to a gene-count and transcript-count matrix for DESeq analysis
gene='2802815_gene_count_matrix_nondisc.csv'
trans='2802815_transcript_count_matrix_nondisc.csv'
python2.7 /export/projects/polyomics/App/prepDE.py -i $gtflist -g $gene -t $trans
